---
title: "Lardieri Midterm Project - Kiva Loans"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

![Data Science for Social Good.](image.png)

##Abstract
My interest is in the social sciences, and the use of data science for social good. From improving global health to city infrastructure, we can use data to help solve major societal issues. In my career, I'd like to contribute to these efforts.

I chose my project because it aligns with my goal of working with data for social good. I will see whether loans are su
 
Kiva.org is an international nonprofit whose mission is to connect people through lending to help alleviate poverty. Kiva supports 3 million borrowers in more than 80 countries, empowering people to create opportunities for themselves, their families, and their communities. My project aims to take a deeper look at the Kiva data, to see if there are any underlying themes or behaviors that differ between regions and countries. Specifically, is there variation in category and amount of funding and to whom. 
- Most imporverished areas
- What is being funded/partially funded/not funded and likelihood?
- Female vs. male borrowers and whether having a male in the group affects loan behavior?
- Repeat and type of borrowers

EDA plot outcome on number of F and number of male and ratio of male count to female count to inform us whether count and proportion make sense. 
Does a male impact on the loan. 
Number of females might not matter, but once adding in a male that could affect the loan amount.
Linear regression model per country on amount of loan for gender
Multilevel model consider country as random effect and gender as random slope (if gender does in fact make a difference on amount from EDA)

##Method
My dataset is sourced and merged from 2 Kaggle datasets; Kiva loan detail and multidimenisonal poverty index (MPI) detail. 

Note that there is more data to be merged that will be relevant to analysis, loan theme by region, human development index, and population below the poverty line.

Variables $Year, Country, World Region, Sector, Activity, Gender, Type of Borrower, Funded Loan Amount, MPI$

##Conclusion
TBD
Response
term of loan
funded or not funded
funded, partially funded, or not funded
female vs male probability of getting funded
type of loan probability of getting funded

how effective are loans? repeat borrowers, type of loan (6 type of loans given)

#Dataset 1: Kiva loan
The dataset contains the majority of the loan detail. 
```{r, echo=FALSE, message=FALSE,warning=FALSE}
library(plyr)
library(dplyr)
library(tidyr)
library(arm)
library(stats)
library(DT)
library(gridExtra)
library(kableExtra)
library(stringr)
library(knitr)
library(ggplot2)
library(data.table)
library(gtools)
library(ggplot2)
library(grid)
# read kiva data
df<-read.csv("kiva_loans.csv",na.strings = c("","NA"))
#length(unique(df$id)) 671,205 loans
kiva_loan <- df
# kiva_loan.tags separates tags (for example, "Elderly, Woman Owned Biz") and remove # from text
kiva_loan.tags <- df%>%mutate(tags=strsplit(as.character(tags),","))%>%unnest(tags)
kiva_loan.tags$tags <- gsub("#","",kiva_loan.tags$tags, fixed=TRUE)

# date conversion and add month and year as columns
kiva_loan$date <- as.Date(kiva_loan$date , "%Y-%m-%d")
kiva_loan <- kiva_loan%>%mutate(month=format(date, "%m"), year=format(date,"%Y"))
# sort by id
kiva_loan <- kiva_loan[order(kiva_loan$id),]

# select specific columns
kiva_loan1 <- kiva_loan%>%dplyr::select(partner_id, funded_amount,loan_amount,sector,activity,country,region,borrower_genders,use, term_in_months,date,month,year,tags)%>%na.omit()

# count number of female / male per loan
kiva_loan1$Female.count <- str_count(kiva_loan1$borrower_genders, "\\bfemale\\b")
kiva_loan1$Male.count <- str_count(kiva_loan1$borrower_genders, "\\bmale\\b")
kiva_loan1$Woman.Biz <- str_count(kiva_loan1$tags, "\\bWoman Owned Biz\\b")

# if a male was involved on the loan, female on loan, male on loan, female only loan
kiva_loan1$M.F.loan <- ifelse(kiva_loan1$Female.count>0&kiva_loan1$Male.count>0,1,0)
kiva_loan1$F.loan <- ifelse(kiva_loan1$Female.count>0,1,0)
kiva_loan1$M.loan <- ifelse(kiva_loan1$Male.count>0,1,0)
kiva_loan1$F.only.loan <- ifelse(kiva_loan1$Female.count>0&kiva_loan1$Male.count==0,1,0)
kiva_loan1$M.only.loan <- ifelse(kiva_loan1$Male.count>0&kiva_loan1$Female.count==0,1,0)

# funded, unfunded, partially funded
kiva_loan1$fully.funded <- ifelse(kiva_loan1$loan_amount==kiva_loan1$funded_amount,1,0)
kiva_loan1$unfunded <- ifelse(kiva_loan1$funded_amount==0,1,0)
kiva_loan1$partial.funded <- ifelse(kiva_loan1$funded_amount<kiva_loan1$loan_amount,1,0)

# detect all female, all male or female and male borrowers
kiva_loan1$borrower_genders <- as.character(kiva_loan1$borrower_genders,fixed=TRUE)
kiva_loan1$borrower_genders <- gsub(" ","",kiva_loan1$borrower_genders)
kiva_loan1$Gender <- sapply(strsplit(kiva_loan1$borrower_genders, ",",fixed = TRUE), function(x)paste(unique(x),collapse=","))

# add variable if just female (0), just male (1), or female and male (2)
kiva_loan1 <- kiva_loan1%>%mutate(Gender.Var=ifelse(Gender=="female",1,ifelse(Gender=="male",2,ifelse(Gender=="female,male",3,3))))

# add variable for "water" from use
kiva_loan1$Water <- as.integer(grepl(pattern="water",x=kiva_loan1$use))
#datatable(head(kiva_loan1,5),class="table-condensed",style="bootstrap")

#data to join with MPI
kiva_loan.join <- kiva_loan1%>%dplyr::select(loan_amount,funded_amount,country)%>%group_by(country)%>%summarise(sumloan_amount=sum(loan_amount),sumfunded_amount=sum(funded_amount))
kiva_loan.join.d <- distinct(kiva_loan.join)
kiva_loan
# to join sector and activity with world_region
kiva_loan.join.s <- kiva_loan1%>%dplyr::select(funded_amount,loan_amount,country,sector,activity)
kiva_loan.join.s1 <- distinct(kiva_loan.join.s)
kiva_loan.join.s.d <- kiva_loan.join.s1%>%group_by(country,sector)%>%mutate(loan_amount.sector=sum(loan_amount),funded_amount.sector=sum(funded_amount))%>%group_by(country,activity)%>%mutate(loan_amount.activity=sum(loan_amount),funded_amount.activity=sum(funded_amount))
kable_kiva <- kiva_loan1%>%dplyr::select(partner_id, funded_amount,loan_amount,sector, activity,use,tags, country,region,borrower_genders,date)
kable_kiva_head <- kable_kiva[1:5,]
kable_styling(kable(kable_kiva_head,full_width=TRUE))

```

```{r, echo=FALSE, message=FALSE,warning=FALSE,fig.height=10,fig.width=10}

par(mfrow=c(2, 2))

# gender loan breakdown
sprintf("No. of Total Loans = %s", nrow(kiva_loan1[kiva_loan1$partner_id,]))
sprintf("Female Only Loans = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$F.only.loan==1,])/nrow(kiva_loan1[kiva_loan1$partner_id,])))
sprintf("Male Only Loans = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$M.only.loan==1,])/nrow(kiva_loan1[kiva_loan1$partner_id,])))
sprintf("Female+Male Loans = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$M.F.loan==1,])/nrow(kiva_loan1[kiva_loan1$partner_id,])))

# gender + funded status breakdown
sprintf("Total Loans - Funded = %.0f%%",100* nrow(kiva_loan1[kiva_loan1$fully.funded==1,])/nrow(kiva_loan1[kiva_loan1$partner_id,]))
sprintf("Female Only Loans - Funded = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$F.only.loan==1&kiva_loan1$fully.funded==1,])/nrow(kiva_loan1[kiva_loan1$F.only.loan==1,])))
sprintf("Male Only Loans - Funded = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$M.only.loan==1&kiva_loan1$fully.funded==1,])/nrow(kiva_loan1[kiva_loan1$M.only.loan==1,])))
sprintf("Female+Male Loans - Funded = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$M.F.loan==1&kiva_loan1$fully.funded==1,])/nrow(kiva_loan1[kiva_loan1$M.F.loan==1,])))
# table overall gender var
n

# chart proportion visual and then breakout by country and region
detach(package:plyr) #need to detach plyr for grouping to work
gender1<-as.data.frame(table(kiva_loan1$Gender.Var,kiva_loan1$region))
colnames(gender1)<-c("Gender.Var","region","Frequency")
gender.region <- gender1%>%group_by(region)%>%mutate(freq=sum(Frequency),freq.prop=paste(Frequency/sum(Frequency)*100))
gender.region[order(-gender.region$freq),]

gender2<-as.data.frame(table(kiva_loan1$Gender.Var,kiva_loan1$country))
colnames(gender2)<-c("Gender.Var","country","Frequency")
gender.country <- gender2%>%group_by(country)%>%mutate(freq=sum(Frequency),freq.prop=paste(Frequency/sum(Frequency)*100))
gender.country[order(-gender.country$freq),]

# top 10 proportions where male >50%
gender.region$freq.prop <- as.numeric(gender.region$freq.prop)
tbl_df(gender.region)%>%filter(Gender.Var==2&freq.prop>50) # about 2,300 regions where male prop >50%
tbl_df(gender.region)%>%filter(Gender.Var==2&freq.prop>50)%>%top_n(10,wt=freq) # top 10 regions based on frequency

gender.country$freq.prop <- as.numeric(gender.country$freq.prop)
tbl_df(gender.country)%>%filter(Gender.Var==2&freq.prop>50) # 18 countries where male prop >50%
tbl_df(gender.country)%>%filter(Gender.Var==2&freq.prop>50)%>%top_n(10,wt=freq) # top 10 countries based on frequency


# top freq regions where female > 50%
tbl_df(gender.region)%>%filter(Gender.Var==1&freq.prop>50) # almost 8,000 regions where female prop >50%
tbl_df(gender.region)%>%filter(Gender.Var==1&freq.prop>50)%>%top_n(10,wt=freq) # top 10 regions based on frequency

tbl_df(gender.country)%>%filter(Gender.Var==1&freq.prop>50) # 52 countries where female prop >50%
tbl_df(gender.country)%>%filter(Gender.Var==1&freq.prop>50)%>%top_n(10,wt=freq) # top 10 countries based on frequency

# plot top 10 proportional regions male and female
gender.f <- gender.region%>%filter(region=="Eldoret"|region=="Kitale"|region=="Lahore"|region=="Managua"|region=="Medellín"|region=="Multan"|region=="Rawalpindi"|region=="San Gabriel"|region=="San Miguel"|region=="Thanh Hoá")
gender.f$Gender.Var1 <- recode(gender.f$Gender.Var,"1"="Female","2"="Male","3"="Male+Female")
gender.m <- gender.region%>%filter(region=="Baniswef"|region=="Ciudad El Triunfo"|region=="El Transito"|region=="Fort Portal"|region=="Gegharkunik region"|region=="Hoima"|region=="Kaduna"|region=="Kamwenge"|region=="Kasese"|region=="Kisii")
gender.m$Gender.Var1 <- recode(gender.f$Gender.Var,"1"="Female","2"="Male","3"="Male+Female")

#ordered by total loan frequency
topf.plot <- ggplot(gender.f, aes(fill=Gender.Var1, y=Frequency, x=reorder(region,-Frequency)))+geom_bar(stat="identity",position="fill")+scale_fill_manual(values=c("#99CCFF","#006699","#66CC33"))+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=19),axis.text.x=element_text(angle=30, hjust=1))+labs(title = "Highest Number of Female Loans",subtitle = "", y="",x="")+theme(plot.title = element_text(hjust=0.5))
topm.plot<-ggplot(gender.m, aes(fill=Gender.Var1, y=Frequency, x=reorder(region,-Frequency)))+geom_bar(stat="identity",position="fill")+scale_fill_manual(values=c("#99CCFF","#006699","#66CC33"))+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=19),axis.text.x=element_text(angle=30, hjust=1))+labs(title = "Highest Number of Male Loans", subtitle = "", y="",x="")+theme(plot.title = element_text(hjust=0.5))

grid.arrange(topf.plot,topm.plot, nrow=2, bottom="Region",left="Frequency", top=textGrob("",gp=gpar(fontsize=15,font=10)))

```



```{r, echo=FALSE, message=FALSE}

sum(kiva_loan1$Woman.Biz)

```


```{r, echo=FALSE, message=FALSE}

# read loan theme by region
df1<-read.csv("loan_themes_by_region.csv",na.strings = c("","NA"))
#head(df1)
# fix Partner.ID to id
setnames(df1, "Partner.ID","partner_id")
# unselect geo, lat, lon etc and omit na
df2 <- df1%>%dplyr::select(partner_id,country, rural_pct,sector,Loan.Theme.Type)%>%na.omit()
```

#Dataset 2: Multidimensional Poverty Index (MPI) and World Region detail
```{r,echo=FALSE,message=FALSE}
# read poverty index for region
mpi <- read.csv("kiva_mpi_region_locations.csv", na.strings=c("","NA"))
# select specific columns
mpi1 <- mpi%>%dplyr::select(country,region,world_region,MPI)%>%na.omit()
world.region <- mpi%>%dplyr::select(country,region,world_region)%>%na.omit()
#datatable(head(mpi,5),class="table-condensed",style="bootstrap")
```

```{r,echo=FALSE, message=FALSE,warning=FALSE}
#join by country and omit nas (Country + Region + World Region + MPI + Loan by Country)
mpi.loan.join <- mpi1%>%left_join(kiva_loan.join.d,by="country")%>%na.omit()

#grouped by country and sector for loan information (World Region + sector + activity + loan by sector + loan by activity)
mpi.loan.join.s <- world.region%>%left_join(kiva_loan.join.s.d,by="country")%>%na.omit()
mpi.loan.join.s1 <- mpi.loan.join.s%>%dplyr::select(country,world_region,sector,activity,loan_amount.sector,loan_amount.activity,funded_amount.sector,funded_amount.activity)
mpi.loan.join.s.d <- distinct(mpi.loan.join.s1)

#convert loan amount into millions
mpi.loan.join$sumloan_amount <-format(mpi.loan.join$sumloan_amount/1e6,digits=2)
mpi.loan.join$sumfunded_amount <-format(mpi.loan.join$sumfunded_amount/1e6,digits=2)
mpi.loan.join$sumloan_amount<- as.numeric(mpi.loan.join$sumloan_amount)
mpi.loan.join$sumfunded_amount<- as.numeric(mpi.loan.join$sumfunded_amount)

# summarize loan and MPI by country
mpi.loan.join1 <- mpi.loan.join%>%group_by(country)%>%mutate(MPI_country=mean(MPI))
mpi.country.join <- mpi.loan.join1%>%dplyr::select(country,MPI_country,sumloan_amount,sumfunded_amount)
mpi.country.join.d <- distinct(mpi.country.join)

# World Region + Country + Mean MPI by Country + Loan by Country
mpi.loan.country.region <- mpi.loan.join1%>%dplyr::select(world_region,country,MPI_country,sumloan_amount,sumfunded_amount)
mpi.loan.country.region.d <- distinct(mpi.loan.country.region)

#summarize loan and MPI by region
mpi.world_region.join <- mpi.loan.join1%>%dplyr::select(country,world_region,sumloan_amount,sumfunded_amount,MPI_country)
mpi.world_region.d <- distinct(mpi.world_region.join)
mpi.world_region.d1 <- mpi.world_region.d%>%group_by(world_region)%>%mutate(sumloan_amount.region=sum(sumloan_amount),MPI_region=mean(MPI_country),sumfunded_amount.region=sum(sumfunded_amount))
mpi.world_region.d2 <- mpi.world_region.d1%>%dplyr::select(world_region,sumloan_amount.region,sumfunded_amount.region,MPI_region)
mpi.world_region.d3 <-distinct(mpi.world_region.d2)

```

#Distribution of Fully Funded, Partially Funded, and Unfunded Loans
```{r,echo=FALSE,message=FALSE}
par(mfrow=c(3,3))

# only funded loans where funded_amount is greater than 0
funded <- kiva_loan1%>%filter(funded_amount==loan_amount)%>%dplyr::select(country,funded_amount)
# log transform
funded$log.funded <- log(funded$funded_amount)
# unfunded loans
unfunded <- kiva_loan1%>%filter(funded_amount==0)
# log transform
unfunded$log.funded <- log(unfunded$loan_amount)
partial <- kiva_loan1%>%filter(funded_amount<loan_amount)
# log transform
partial$log.funded <- log(partial$funded_amount)

print(c(Unfunded_Amount=count(unfunded),Partial_Amount=count(partial),Funded_Amount=count(funded)))

ggplot(data=funded, aes(x=log.funded))+geom_histogram(col="black",fill="seagreen3")+theme(plot.title=element_text(hjust =0.5,size=19))+labs(title = "Distribution of Fully Funded Loans (Log Scale)", y="Count",x="exp(Loan Amount)")+scale_x_continuous(breaks=c(3,5,7,11), labels=c(format(exp(3),digits=3),format(exp(5),digits=3),format(exp(7),digits=3),format(exp(11),digits=3)))

#d.unfunded <- ggplot(data=unfunded, aes(x=log.funded))+geom_histogram(col="black",fill="seagreen3")+theme(plot.title=element_text(hjust =0.5,size=19))+labs(title = "Distribution of Unfunded Loans (Log Scale)", y="Count",x="exp(Loan Amount)")+scale_x_continuous(breaks=c(3,5,7,11), labels=c(format(exp(3),digits=3),format(exp(5),digits=3),format(exp(7),digits=3),format(exp(11),digits=3)))

#d.partial <- ggplot(data=partial, aes(x=log.funded))+geom_histogram(col="black",fill="seagreen3")+theme(plot.title=element_text(hjust =0.5,size=19))+labs(title = "Distribution of Partially Funded Loans (Log Scale)", y="Count",x="exp(Loan Amount)")+scale_x_continuous(breaks=c(3,5,7,11), labels=c(format(exp(3),digits=3),format(exp(5),digits=3),format(exp(7),digits=3),format(exp(11),digits=3)))
```

In the dataset, there were 5,199 unfunded loans (funded amount is $0), 124,555 partially funded loans (funded amount is less than loan amount), and 1,342,420 fully funded loans. Over 91% of Kiva loans are fully funded.

From the histogram, the fully funded amounts in the dataset range from about 20 USD to about 5,9875 USD with an average of about 1,100 USD. 

What is the breakdown of funded loans by Country and Region? 

#Frequently Funded Countries and Regions
```{r, echo=FALSE,fig.height=8, fig.width=8, message=FALSE}
library(ggplot2)
library(wesanderson)
par(mfrow=c(2,2))

# countries with fully funded loans only
kl2 <- kiva_loan1%>%filter(funded_amount==loan_amount)
# create data frame
kl2 <-as.data.frame(table(kiva_loan1$country,kiva_loan1$year))
colnames(kl2)<-c("country","year","Frequency")

# bar plots of top 5 funded countries per year
p1 <- kl2%>%filter(year=="2014")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(country,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="dark orange1")+facet_wrap(~year)+labs(x="",y="")
p2 <- kl2%>%filter(year=="2015")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(country,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="dark orange1")+facet_wrap(~year)+labs(x="",y="")
p3 <- kl2%>%filter(year=="2016")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(country,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="dark orange1")+facet_wrap(~year)+labs(x="",y="")
p4 <- kl2%>%filter(year=="2017")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(country,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="dark orange1")+facet_wrap(~year)+labs(x="",y="")

grid.arrange(p1,p2,p3,p4, nrow=2, bottom="Country",left="Frequency", top=textGrob("Top 5 Funded Countries per Year",gp=gpar(fontsize=15,font=10)))
```

From the bar plots, the top funded countries are consistently the Philippines and Kenya each year, Cambodia is also frequntly funded.

```{r, echo=FALSE,fig.height=8, fig.width=8, message=FALSE}
par(mfrow=c(2,2))
# create data frame
k.region <-as.data.frame(table(kiva_loan1$region,kiva_loan1$year))
colnames(k.region)<-c("region","year","Frequency")

# bar plots of top 5 funded countries per year
p.k1 <- k.region%>%filter(year=="2014")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(region,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="tomato1")+facet_wrap(~year)+labs(x="",y="")+theme(axis.text.x=element_text(angle=30, hjust=1))
p.k2 <- k.region%>%filter(year=="2015")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(region,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="tomato1")+facet_wrap(~year)+labs(x="",y="")+theme(axis.text.x=element_text(angle=30, hjust=1))
p.k3 <- k.region%>%filter(year=="2016")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(region,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="tomato1")+facet_wrap(~year)+labs(x="",y="")
p.k4 <- k.region%>%filter(year=="2017")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(region,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="tomato1")+facet_wrap(~year)+labs(x="",y="")

grid.arrange(p.k1,p.k2,p.k3,p.k4, nrow=2, bottom="Region",left="Frequency", top=textGrob("Top 5 Funded Regions per Year",gp=gpar(fontsize=21,font=10)))
```

From the bar plot, there is a mix of top regions that are top funded per year. 

Is there a relationship between where the loans are funded and the poverty index of those locations - are the countries and regions who need the funding the most receiving it?

#Relationship of Funded Loan Amount and Poverty Index (MPI)
```{r, echo=FALSE, fig.height=5,fig.width=12,message=FALSE,warning=FALSE}
par(mfrow=c(2,2))
library(treemapify)
library(treemap)
library(RColorBrewer)
library(gridExtra)

#mean.region1$meanLoanWorldRegion<- round(mean.region1$meanLoanWorldRegion)
mpi.world_region.d3$label <- paste(mpi.world_region.d3$world_region, mpi.world_region.d3$sumfunded_amount.region, sep=", ")

#size is total loan
treemap(mpi.world_region.d3, index="label",vSize="sumfunded_amount.region",vColor="MPI_region",title="Loans by World Region (Total in $M)",title.legend = "Region MPI (mean)", type="value",range=c(0.30,0.05),position.legend= "right", palette=brewer.pal(n=5,"RdYlGn"))

#t2 <- ggplot(mean.region1, aes(area=meanLoanWorldRegion,fill=meanMPI,label=label,meanLoanWorldRegion))+geom_treemap()+geom_treemap_text(fontface="italic",color="white",placec="center",grow=TRUE)
```

From the treemap, Sub-Saharan Africa is the poorest World Region and has received a large portion of the total Kiva loans. While South Asia, high on the poverty index, receives the second smallest portion of Kiva loans. 

Latin America and Caribbean are lower on the poverty index, but receive the second largest portion of Kiva loans. 

Will focus on these 3 regions and dig deeper into these differences and what other factors are playing into loan distribution.

```{r, echo=FALSE, fig.height=5,fig.width=12,message=FALSE,warning=FALSE}
# countries within Sub-Saharan Africa
mpi.country.Africa <- filter(mpi.loan.country.region.d, world_region=="Sub-Saharan Africa")
mpi.country.Africa$label <- paste(mpi.country.Africa$country, mpi.country.Africa$sumfunded_amount, sep=", ")
treemap(mpi.country.Africa, index="label",vSize="sumfunded_amount",vColor="MPI_country",title="Loans by Country in Sub-Saharan Africa (Total in $M)",title.legend = "Country MPI (mean)", type="value",range=c(0.50,0.20),position.legend= "right", palette=brewer.pal(n=5,"RdYlGn"))

# countries within Latin America and Caribbean
mpi.country.LA <- filter(mpi.loan.country.region.d, world_region=="Latin America and Caribbean")
mpi.country.LA$label <- paste(mpi.country.LA$country, mpi.country.LA$sumfunded_amount, sep=", ")
treemap(mpi.country.LA, index="label",vSize="sumfunded_amount",vColor="MPI_country",title="Loans by Country in Latin America and Caribbean (Total in $M)",title.legend = "Country MPI (mean)", type="value",range=c(0.50,0.10),position.legend= "right", palette=brewer.pal(n=5,"RdYlGn"))

# countries within South Asia
mpi.country.SA <- filter(mpi.loan.country.region.d, world_region=="South Asia")
mpi.country.SA$label <- paste(mpi.country.SA$country, mpi.country.SA$sumfunded_amount, sep=", ")
treemap(mpi.country.SA, index="label",vSize="sumfunded_amount",vColor="MPI_country",title="Loans by Country in South Asia (Total in $M)",title.legend = "Country MPI (mean)", type="value",range=c(0.50,0.20),position.legend= "right", palette=brewer.pal(n=5,"RdYlGn"))
```

From these treemaps, some of the poorest countries are receiving a small portion of the total Kiva loans for the region. 

Burkina and South Sudan within Sub-Saharan Africa, Haiti within Latin America and Caribbean, and Afghanistan within South Asia are receiving a small portion of the funded amounts.

These are areas to dive deeper into the loan trends and what is driving these differences. 

#Frequently Funded Sectors
```{r, echo=FALSE,fig.height=10, fig.width=10,message=FALSE}
par(mfrow=c(2,2))

# countries with funded loans only
kl3 <- kiva_loan1%>%filter(funded_amount==loan_amount)
# create data frame
kl3 <-as.data.frame(table(kiva_loan1$sector,kiva_loan1$year))
colnames(kl3)<-c("sector","year","Frequency")

# bar plots of top 5 funded countries per year
p5 <- kl3%>%filter(year=="2014")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(sector,-Frequency),y=Frequency))+geom_bar(stat="identity",fill=" slateblue")+facet_wrap(~year)+labs(x="",y="")
p6 <- kl3%>%filter(year=="2015")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(sector,-Frequency),y=Frequency))+geom_bar(stat="identity",fill=" slateblue")+facet_wrap(~year)+labs(x="",y="")
p7 <- kl3%>%filter(year=="2016")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(sector,-Frequency),y=Frequency))+geom_bar(stat="identity",fill=" slateblue")+facet_wrap(~year)+labs(x="",y="")
p8 <- kl3%>%filter(year=="2017")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(sector,-Frequency),y=Frequency))+geom_bar(stat="identity",fill=" slateblue")+facet_wrap(~year)+labs(x="",y="")


grid.arrange(p5,p6,p7,p8, nrow=2, bottom="Sector",left="Frequency", top=textGrob("Top 5 Funded Sectors per Year",gp=gpar(fontsize=15,font=10)))

```

From the bar plots, the top funded sectors are consistently Agriculture, Food, and Retail. What is the funded loan breakdown for these top sectors for World Region and Country?

#Proportion of Funded Loans for Top Sectors by World Region 
```{r, echo=FALSE,fig.height=8, fig.width=10,message=FALSE}
par(mfrow=c(2,2))
top.3.group <- mpi.loan.join.s.d%>%mutate(allother=ifelse(sector=="Agriculture","Agriculture",ifelse(sector=="Food","Food",ifelse(sector=="Retail","Retail","All Other"))))

#change order
top.3.group$allother <- factor(top.3.group$allother, levels = c("All Other","Retail","Food","Agriculture"))
top.3.group <- as.data.frame(top.3.group)
#size is total loan
#top.3.p <- ggplot(top.3, aes(fill=world_region,y=funded_amount.sector,x=sector))+geom_bar(stat="identity",position="fill")+guides(fill=guide_legend(title="World Region"))+theme(text=element_text(size=19))+labs(title = "", subtitle = "", y="",x="")

top.3.p1 <- ggplot(top.3.group, aes(fill=allother,y=funded_amount.sector,x=world_region))+geom_bar(stat="identity",position="fill")+guides(fill=guide_legend(title="Sector"))+theme(text=element_text(size=19),axis.text.x=element_text(angle=30, hjust=1))+labs(title = "", subtitle = "", y="",x="")

grid.arrange(top.3.p1, nrow=1,left=textGrob("Proportion of Funded Loans",rot=90, gp=gpar(fontsize=14)),bottom=textGrob("World Region", gp=gpar(fontsize=14,font=11)),top=textGrob("Relationship Between World Regions and Top Sectors ", gp=gpar(fontsize=14,font=11)))
```

The chart indicates that although Agricultural loans are the most frequently funded, they make up a smaller dollar proportion of funded loan amounts. 
Recalling the treemap by World Region, are there similar breakdowns further by countries in Sub-Saharan Africa, Latin America and Caribbean, and South Asia?


```{r, echo=FALSE,fig.height=8, fig.width=15,message=FALSE}
# Sub-Saharan Africa
top.3.Africa <- mpi.loan.join.s.d%>%filter(world_region=="Sub-Saharan Africa")
top.3.Africa1 <- top.3.Africa%>%mutate(allother=ifelse(sector=="Agriculture","Agriculture",ifelse(sector=="Food","Food",ifelse(sector=="Retail","Retail","All Other"))))

#change order
top.3.Africa1$allother <- factor(top.3.Africa1$allother, levels = c("All Other","Retail","Food","Agriculture"))
top.3.Africa1 <- as.data.frame(top.3.Africa1)
# log scale
top.3.Africa1$log.funded_amount.sector <- log(top.3.Africa1$funded_amount.sector)

top.3.p2 <- ggplot(top.3.Africa1, aes(y=log.funded_amount.sector,x=reorder(country,-log.funded_amount.sector),fill=allother))+geom_bar(stat="identity")+guides(fill=guide_legend(title="Sector"))+theme(text=element_text(size=19),axis.text.x=element_text(angle=30, hjust=1))+labs(title = "", subtitle = "", y="",x="")


grid.arrange(top.3.p2, nrow=1,left=textGrob("Funded Loans",rot=90, gp=gpar(fontsize=19)),bottom=textGrob("Country", gp=gpar(fontsize=19,font=11)),top=textGrob("Relationship Between Sub-Saharan Africa and Top Sectors ", gp=gpar(fontsize=19,font=11)))
```

#How are loans being used?
```{r, echo=FALSE,fig.height=10, fig.width=10,message=FALSE, warning=FALSE}
# countries with funded loans only
kl4 <- kiva_loan1%>%filter(funded_amount>0)
# create data frame
kl4 <-as.data.frame(table(kiva_loan1$use,kiva_loan1$year))
colnames(kl4)<-c("use","year","Frequency")

# bar plots of top 5 funded countries per year
p9 <- kl4%>%filter(year=="2014")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(use,Frequency),y=Frequency,fill=gender))+geom_bar(stat="identity",fill=" skyblue4")+facet_wrap(~year)+labs(x="",y="")+coord_flip()
p10 <- kl4%>%filter(year=="2015")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(use,Frequency),y=Frequency))+geom_bar(stat="identity",fill=" skyblue4")+facet_wrap(~year)+labs(x="",y="")+coord_flip()
p11 <- kl4%>%filter(year=="2016")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(use,Frequency),y=Frequency))+geom_bar(stat="identity",fill=" skyblue4")+facet_wrap(~year)+labs(x="",y="")+coord_flip()
p12 <- kl4%>%filter(year=="2017")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(use,Frequency),y=Frequency))+geom_bar(stat="identity",fill=" skyblue4")+facet_wrap(~year)+labs(x="",y="")+coord_flip()

grid.arrange(p9,p10,p11,p12, nrow=4, bottom="Frequency",left="Use of Loan", top=textGrob("Top 5 Funded Use of Loans per Year",gp=gpar(fontsize=15,font=10)))
```

From the bar plots, there is some variation in the use of the loan. For water uses, does this vary by region and become more prominent during dry seasons? If there is an expected dry season can we expect water loans to increase?

##Where is the use of water loan most prevelant?
```{r, echo=FALSE,message=FALSE,warning=FALSE}
water <- kiva_loan1%>%filter(funded_amount>0)%>%dplyr::select(country,Water)%>%group_by(country)%>%summarise(watertotal=sum(Water),watercount=n())
water1 <- water%>%arrange(desc(watercount))%>%slice(1:5)
plotwater <- ggplot(water1, aes(x=reorder(country,-watercount),y=watercount))+geom_bar(stat="identity",fill="light blue")+scale_fill_manual(values=c("#66CC33"))+theme(plot.title=element_text(hjust =0.5,size=19))+labs(title = "Top 5 Funded Water Loans", y="Frequency",x="Country")
plotwater

```
#Loan Breakdown by Gender
```{r echo=FALSE, fig.height=8, fig.width=12,warning=FALSE}
# log transform
kiva_loan1$log.funded <- log(kiva_loan1$funded_amount)

# recode female,male and male,female as the same
kiva_loan1$Gender <- recode(kiva_loan1$Gender, "female,male"="male,female")

# gender differences in funded loan distribution
plot.gender <- ggplot(kiva_loan1, aes(x=Gender, y=log.funded,fill=Gender)) + 
  geom_violin()+labs(title = "", y="",x="")+
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color="red", fill="red") +
    scale_fill_brewer(palette="Set3")+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=16))
# group male,female and male as 0 and female as 1
kiva.gender <-kiva_loan1
kiva.gender$Gender.Var[kiva.gender$Gender.Var==0] <- 0 # female
kiva.gender$Gender.Var[kiva.gender$Gender.Var>0] <- 1 #male and female+male
gender.group <- kiva.gender%>%mutate(Gender1 = recode(Gender.Var, "0"="female", "1"="male,male+female"))

plot.gender2 <- ggplot(gender.group, aes(x=Gender1, y=log.funded,fill=Gender1)) + 
  geom_violin()+labs(title = "", y="",x="")+
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color="red", fill="red") +
    scale_fill_brewer(palette="Set3")+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=16))

grid.arrange(plot.gender,plot.gender2, nrow=1,left=textGrob("Funded Loan (Log Scale)",rot=90, gp=gpar(fontsize=14)),bottom=textGrob("Gender", gp=gpar(fontsize=14,font=11)),top=textGrob("Relationship Between Funded Loan Amount and Gender ", gp=gpar(fontsize=14,font=11)))
```

From the violin plots, there is a difference in the average funded loan amount (red dot) between females and males on an overall basis. 

We may see even bigger differences by looking at the gender differences across World Regions and Countries and over time. 

```{r, echo=FALSE, fig.height=8, fig.width=12,warning=FALSE}
ggplot(kiva_loan1, aes(x=Gender, y=log.funded,fill=Gender)) + 
  geom_violin()+labs(title = "", y="",x="")+
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color="red", fill="red") +
    scale_fill_brewer(palette="Set3")+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=16))+facet_wrap(~year)


```

From the violin plots by year, the average loans overall seem to be decreasing, but also leveling between female, male, and male+female. 

We may see something interesting across World Regions and Countries. 

```{r, echo=FALSE, fig.height=8, fig.width=12,warning=FALSE}
# need to join mpi for world region information with gender
kiva_loan1.red <- kiva_loan1%>%dplyr::select(partner_id, funded_amount, loan_amount, sector, activity, country, use, term_in_months, year, tags, Gender, Gender.Var, Water, log.funded)

kiva_loan1.gr <- world.region%>%left_join(kiva_loan1.red,by="country")%>%na.omit()
kiva_loan1.gr1 <- kiva_loan1.gr%>%filter(kiva_loan1.gr$world_region=="South Asia"|kiva_loan1.gr$world_region=="Sub-Saharan Africa")

# add face_wrap by world_region
ggplot(kiva_loan1.gr1, aes(x=Gender, y=log.funded)) + 
  geom_violin()+labs(title = "", y="",x="")+
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color="red", fill="red") +
    scale_fill_brewer(palette="Set3")+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=16))+facet_wrap(~world_region)
```

There was just one loan that had male,female variable for South Asia (in 2014).
