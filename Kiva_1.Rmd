---
output: 
  pdf_document:
    latex_engine: pdflatex
title: "Midterm Project - Kiva.org"
author: "Jordan Lardieri - Boston University"
keywords: "kiva, loans, EDA"
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
# spacing: double
endnote: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(
"plyr",
"dplyr",
"tidyr",
"arm",
"stats",
"DT",
"gridExtra",
"kableExtra",
"stringr",
"knitr",
"ggplot2",
"data.table",
"gtools",
"ggplot2",
"grid",
"treemapify",
"treemap",
"RColorBrewer",
"functional",
"lme4"
)
  
```

![Data Science for Social Good.](image.jpg)
##

##Abstract
My interest is in the social sciences, and the use of data science for social good. From improving global health to city infrastructure, we can use data to help solve major societal issues. In my career, I'd like to contribute to these efforts.

I chose my project because it aligns with this goal. I'm interested in *Kiva.org's* cause because they empower so many individuals and communities around the world through crowdsourced loans, not donations. Anyone can go to the website, get familiar with someone's story and make a loan contribution. 

Their website has a number of focus areas; women, single parents, conflict zones, water, and education to name a few. As a nonprofit, *Kiva's* mission is to connect people through lending to help alleviate poverty. Kiva supports 3 million borrowers in more than 80 countries, creating opportunities for individuals, their families, and their communities. 

My project aims to take a deeper look at the Kiva loan data, to see if there are any underlying themes and behaviors that differ between regions and countries. Specifically, is there variation in category and amount of funding and to whom.

![Kiva.org.](kiva.png)


##Method
The dataset is sourced and merged from 2 Kaggle datasets; loan detail from *Kiva.org* and regional multidimenisonal poverty index (MPI) detail. It was reshaped to have tag information per row (tags are additional information provided for borrowers, for example, "Elderly","Woman Owned Biz"). 

Variables $Partner.ID, Country, Region, World Region, Sector, Activity, Use, Tags, Gender, Tags, Date, Funded Loan Amount, Loan Amount, MPI$

Note that there is more data to be merged that will be relevant to analysis, loan theme by region, human development index, and population below the poverty line in the future. 


#Dataset 1: Kiva Loans
The dataset contains the majority of the loan detail provided by *Kiva*. 
```{r, echo=FALSE, message=FALSE,warning=FALSE}
# read kiva data
df<-read.csv("kiva_loans.csv",na.strings = c("","NA"))

#length(unique(df$id)) 671,205 loans
kiva_loan <- df

# Reshape: kiva_loan.tags separates tags (for example, "Elderly, Woman Owned Biz") and remove # from text
kiva_loan.tags <- df%>%mutate(tags=strsplit(as.character(tags),","))%>%unnest(tags)
kiva_loan.tags$tags <- gsub("#","",kiva_loan.tags$tags, fixed=TRUE)

# Add variable: date conversion and add month + year
kiva_loan$date <- as.Date(kiva_loan$date , "%Y-%m-%d")
kiva_loan <- kiva_loan%>%mutate(month=format(date, "%m"), year=format(date,"%Y"))

# sort by id
kiva_loan <- kiva_loan[order(kiva_loan$id),]

# select specific columns
kiva_loan1 <- kiva_loan%>%dplyr::select(partner_id, funded_amount,loan_amount,sector,activity,country,region,borrower_genders,use, term_in_months,date,month,year,tags)%>%na.omit()

# Add variables: count number of female / male per loan
kiva_loan1$Female.count <- str_count(kiva_loan1$borrower_genders, "\\bfemale\\b")
kiva_loan1$Male.count <- str_count(kiva_loan1$borrower_genders, "\\bmale\\b")
kiva_loan1$Woman.Biz <- str_count(kiva_loan1$tags, "\\bWoman Owned Biz\\b")

# Add Variables: male+female loans, female loans, female only loans, male loans, male only loans
kiva_loan1$M.F.loan <- ifelse(kiva_loan1$Female.count>0&kiva_loan1$Male.count>0,1,0)
kiva_loan1$F.loan <- ifelse(kiva_loan1$Female.count>0,1,0)
kiva_loan1$M.loan <- ifelse(kiva_loan1$Male.count>0,1,0)
kiva_loan1$F.only.loan <- ifelse(kiva_loan1$Female.count>0&kiva_loan1$Male.count==0,1,0)
kiva_loan1$M.only.loan <- ifelse(kiva_loan1$Male.count>0&kiva_loan1$Female.count==0,1,0)

# Add Variables: funded, unfunded, partially funded
kiva_loan1$fully.funded <- ifelse(kiva_loan1$loan_amount==kiva_loan1$funded_amount,1,0)
kiva_loan1$unfunded <- ifelse(kiva_loan1$funded_amount==0,1,0)
kiva_loan1$partial.funded <- ifelse(kiva_loan1$funded_amount<kiva_loan1$loan_amount,1,0)

# detect all female, all male or female and male borrowers
kiva_loan1$borrower_genders <- as.character(kiva_loan1$borrower_genders,fixed=TRUE)
kiva_loan1$borrower_genders <- gsub(" ","",kiva_loan1$borrower_genders)
kiva_loan1$Gender <- sapply(strsplit(kiva_loan1$borrower_genders, ",",fixed = TRUE), function(x)paste(unique(x),collapse=","))
kiva_loan1 <- kiva_loan1%>%mutate(Gender.Var=ifelse(Gender=="female",1,ifelse(Gender=="male",2,ifelse(Gender=="female,male",3,3))))

# Add Variable: for "water" from use (may look at this)
kiva_loan1$Water <- as.integer(grepl(pattern="water",x=kiva_loan1$use))
#datatable(head(kiva_loan1,5),class="table-condensed",style="bootstrap")

#data to join with MPI dataset 2
kiva_loan.join <- kiva_loan1%>%dplyr::select(loan_amount,funded_amount,country)%>%group_by(country)%>%summarise(sumloan_amount=sum(loan_amount),sumfunded_amount=sum(funded_amount))
kiva_loan.join.d <- distinct(kiva_loan.join)

# to join sector and activity with world_region
kiva_loan.join.s <- kiva_loan1%>%dplyr::select(funded_amount,loan_amount,country,sector,activity)
kiva_loan.join.s1 <- distinct(kiva_loan.join.s)
kiva_loan.join.s.d <- kiva_loan.join.s1%>%group_by(country,sector)%>%mutate(loan_amount.sector=sum(loan_amount),funded_amount.sector=sum(funded_amount))%>%group_by(country,activity)%>%mutate(loan_amount.activity=sum(loan_amount),funded_amount.activity=sum(funded_amount))
#kable_kiva <- kiva_loan1%>%dplyr::select(partner_id, funded_amount,loan_amount,sector, activity,use,tags, country,region,borrower_genders,date)
#kable_kiva_head <- kable_kiva[1:5,]
#kable_styling(kable(kable_kiva_head,full_width=TRUE))
head(kiva_loan1)
```

#Dataset 2: Multidimensional Poverty Index (MPI) and World Region Detail
This dataset contains World Region and MPI variables. 
```{r,echo=FALSE,message=FALSE}
# read poverty index for region
mpi <- read.csv("kiva_mpi_region_locations.csv", na.strings=c("","NA"))

# select specific columns
mpi1 <- mpi%>%dplyr::select(country,region,world_region,MPI)%>%na.omit() #mpi also has lat and lon data, would be interesting to create a map
world.region <- mpi%>%dplyr::select(country,region,world_region)%>%na.omit()
#kable_worldr_head <- mpi1[1:5,]
#kable_styling(kable(kable_worldr_head,full_width=TRUE))
head(mpi1)
```


##Datasets Merged
This is one iteration of the dataset. I summarized loans and MPI separately by world region, region, and country for analysis. 
```{r,echo=FALSE, message=FALSE,warning=FALSE}
#join by country and omit nas (Country + Region + World Region + MPI + Loan by Country)
mpi.loan.join <- mpi1%>%left_join(kiva_loan.join.d,by="country")%>%na.omit()

#convert loan amount into millions
mpi.loan.join$sumloan_amount <-format(mpi.loan.join$sumloan_amount/1e6,digits=2)
mpi.loan.join$sumfunded_amount <-format(mpi.loan.join$sumfunded_amount/1e6,digits=2)
mpi.loan.join$sumloan_amount<- as.numeric(mpi.loan.join$sumloan_amount)
mpi.loan.join$sumfunded_amount<- as.numeric(mpi.loan.join$sumfunded_amount)

#grouped by country and sector for loan information (World Region + sector + activity + loan by sector + loan by activity)
mpi.loan.join.s <- world.region%>%left_join(kiva_loan.join.s.d,by="country")%>%na.omit()
mpi.loan.join.s1 <- mpi.loan.join.s%>%dplyr::select(country,world_region,sector,activity,loan_amount.sector,loan_amount.activity,funded_amount.sector,funded_amount.activity)
mpi.loan.join.s.d <- distinct(mpi.loan.join.s1)

# summarize loan and MPI by country
mpi.loan.join1 <- mpi.loan.join%>%group_by(country)%>%mutate(MPI_country=mean(MPI))
mpi.country.join <- mpi.loan.join1%>%dplyr::select(country,MPI_country,sumloan_amount,sumfunded_amount)
mpi.country.join.d <- distinct(mpi.country.join)

# World Region + Country + Mean MPI by Country + Loan by Country
mpi.loan.country.region <- mpi.loan.join1%>%dplyr::select(world_region,country,MPI_country,sumloan_amount,sumfunded_amount)
mpi.loan.country.region.d <- distinct(mpi.loan.country.region)

#summarize loan and MPI by region
mpi.world_region.join <- mpi.loan.join1%>%dplyr::select(country,world_region,sumloan_amount,sumfunded_amount,MPI_country)
mpi.world_region.d <- distinct(mpi.world_region.join)
mpi.world_region.d1 <- mpi.world_region.d%>%group_by(world_region)%>%mutate(sumloan_amount.region=sum(sumloan_amount),MPI_region=mean(MPI_country),sumfunded_amount.region=sum(sumfunded_amount))
mpi.world_region.d2 <- mpi.world_region.d1%>%dplyr::select(world_region,sumloan_amount.region,sumfunded_amount.region,MPI_region)
mpi.world_region.d3 <-distinct(mpi.world_region.d2)

#just country and region
mpi.c.r <- mpi%>%dplyr::select(country,world_region)

#kable_merge_head <- mpi.country.join.d[1:5,]
#kable_styling(kable(kable_merge_head,full_width=TRUE))
head(mpi.country.join.d)
```

```{r, echo=FALSE, message=FALSE}
# this is dataset 3 will want to incorporate this later
# read loan theme by region
#df1<-read.csv("loan_themes_by_region.csv",na.strings = c("","NA"))
#head(df1)
# fix Partner.ID to id
#setnames(df1, "Partner.ID","partner_id")
# unselect geo, lat, lon etc and omit na
#df2 <- df1%>%dplyr::select(partner_id,country, rural_pct,sector,Loan.Theme.Type)%>%na.omit()
```

#The Loans: Distribution of Fully Funded, Partially Funded, and Unfunded Loans
Not all loans receive full funding. 
```{r,echo=FALSE,message=FALSE,warning=FALSE, fig.width=8}
#fully funded loans
sprintf("No. of Fully Funded Loans = %s", nrow(kiva_loan1[kiva_loan1$funded_amount==kiva_loan1$loan_amount,]))
# unfunded loans
sprintf("No. of Unfunded Loans = %s", nrow(kiva_loan1[kiva_loan1$funded_amount==0,]))
# partially funded 
sprintf("No. of Partially Funded Loans = %s", nrow(kiva_loan1[kiva_loan1$funded_amount<kiva_loan1$loan_amount&kiva_loan1$funded_amount!=0,]))
# overfunded 
sprintf("No. of Over Funded Loans = %s", nrow(kiva_loan1[kiva_loan1$funded_amount>kiva_loan1$loan_amount,]))

# log transform
funded <- kiva_loan1
funded$log.funded <- log(funded$funded_amount)

ggplot(data=funded, aes(x=log.funded))+geom_histogram(col="black",fill="seagreen3")+theme(plot.title=element_text(hjust =0.5,size=19))+labs(title = "Distribution of Fully Funded Loans (Log Scale)", y="Count",x="exp(Loan Amount)")+scale_x_continuous(breaks=c(3,5,7,11), labels=c(format(exp(3),digits=3),format(exp(5),digits=3),format(exp(7),digits=3),format(exp(11),digits=3)))

#d.unfunded <- ggplot(data=unfunded, aes(x=log.funded))+geom_histogram(col="black",fill="seagreen3")+theme(plot.title=element_text(hjust =0.5,size=19))+labs(title = "Distribution of Unfunded Loans (Log Scale)", y="Count",x="exp(Loan Amount)")+scale_x_continuous(breaks=c(3,5,7,11), labels=c(format(exp(3),digits=3),format(exp(5),digits=3),format(exp(7),digits=3),format(exp(11),digits=3)))

#d.partial <- ggplot(data=partial, aes(x=log.funded))+geom_histogram(col="black",fill="seagreen3")+theme(plot.title=element_text(hjust =0.5,size=19))+labs(title = "Distribution of Partially Funded Loans (Log Scale)", y="Count",x="exp(Loan Amount)")+scale_x_continuous(breaks=c(3,5,7,11), labels=c(format(exp(3),digits=3),format(exp(5),digits=3),format(exp(7),digits=3),format(exp(11),digits=3)))
```

In the dataset, an unfunded loan is $Funded Amount$=$0, a partially funded loan is funded amount is less than loan amount and fully funded loan is funded amount=loan amount. Over 91% of Kiva loans are fully funded!
From the histogram, the fully funded amounts in the dataset range from about 20 USD to about 5,9875 USD with an average of about 1,100 USD. 
How does this breakdown by $Country$ and $Region$? Is funding going to the most impoverished areas? What about $Gender$? And $Sector$?

#Frequently Funded Countries and Regions
```{r, echo=FALSE,fig.height=8, fig.width=8, message=FALSE}

# countries with fully funded loans only
kl2 <- kiva_loan1%>%filter(funded_amount==loan_amount)
# create data frame
kl2 <-as.data.frame(table(kiva_loan1$country,kiva_loan1$year))
colnames(kl2)<-c("country","year","Frequency")

# bar plots of top 5 funded countries per year
p1 <- kl2%>%filter(year=="2014")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(country,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="dark orange1")+facet_wrap(~year)+labs(x="",y="")
p2 <- kl2%>%filter(year=="2015")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(country,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="dark orange1")+facet_wrap(~year)+labs(x="",y="")
p3 <- kl2%>%filter(year=="2016")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(country,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="dark orange1")+facet_wrap(~year)+labs(x="",y="")
p4 <- kl2%>%filter(year=="2017")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(country,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="dark orange1")+facet_wrap(~year)+labs(x="",y="")

grid.arrange(p1,p2,p3,p4, nrow=2, bottom="Country",left="Frequency", top=textGrob("Top 5 Funded Countries per Year",gp=gpar(fontsize=15,font=10)))
```

From the bar plots, the top funded countries are consistently the Philippines and Kenya each year, Cambodia is also frequntly funded.

```{r, echo=FALSE,fig.height=8, fig.width=8, message=FALSE}
par(mfrow=c(2,2))
# create data frame
k.region <-as.data.frame(table(kiva_loan1$region,kiva_loan1$year))
colnames(k.region)<-c("region","year","Frequency")

# bar plots of top 5 funded countries per year
p.k1 <- k.region%>%filter(year=="2014")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(region,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="tomato1")+facet_wrap(~year)+labs(x="",y="")+theme(axis.text.x=element_text(angle=30, hjust=1))
p.k2 <- k.region%>%filter(year=="2015")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(region,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="tomato1")+facet_wrap(~year)+labs(x="",y="")+theme(axis.text.x=element_text(angle=30, hjust=1))
p.k3 <- k.region%>%filter(year=="2016")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(region,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="tomato1")+facet_wrap(~year)+labs(x="",y="")
p.k4 <- k.region%>%filter(year=="2017")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(region,-Frequency),y=Frequency))+geom_bar(stat="identity",fill="tomato1")+facet_wrap(~year)+labs(x="",y="")

grid.arrange(p.k1,p.k2,p.k3,p.k4, nrow=2, bottom="Region",left="Frequency", top=textGrob("Top 5 Funded Regions per Year",gp=gpar(fontsize=21,font=10)))
```

From the bar plot, there is a mix of top regions that are top funded per year. 

Is there a relationship between frequently funded regions/countries and $MPI$?

#Funded Loan Amount and Poverty Index (MPI)
Here we introduce MPI and the 6 World Regions. This includes only regions and countries with an MPI. 
```{r, echo=FALSE, fig.height=7,fig.width=12,message=FALSE,warning=FALSE}
# show distribution of MPI
sprintf("Max MPI = %.2f", max(mpi$MPI,na.rm=TRUE))
sprintf("Min MPI = %.2f", min(mpi$MPI,na.rm=TRUE))
sprintf("Med MPI = %.2f", median(mpi$MPI,na.rm=TRUE))
sprintf("Mean MPI = %.2f", mean(mpi$MPI,na.rm=TRUE))

ggplot(data=mpi, aes(x=MPI))+geom_histogram(aes(fill=world_region))+theme(plot.title=element_text(hjust =0.5,size=19))+labs(title = "Distribution of Multidimenisonal Poverty Index (MPI)", y="Count",x="MPI")+guides(fill=guide_legend(title="World Region"))
```

From distribution, the poorest world regions are Sub-Saharan Africa and South Asia. What proportion of loans are these $World Region$s receiving?
```{r, echo=FALSE, fig.height=5,fig.width=12,message=FALSE,warning=FALSE}
par(mfrow=c(2,2))
# region breakdown
sprintf("No. of Total Regions = %s", length(unique(mpi[,"region"]))-1)
sprintf("No. of Total Countries = %s", length(unique(mpi[,"country"]))-1)
sprintf("No. of Total World Regions = %s", length(unique(mpi[,"world_region"]))-1) #counts column name 

# use loan amount for label
mpi.world_region.d3$label <- paste(mpi.world_region.d3$world_region, mpi.world_region.d3$sumfunded_amount.region, sep=", ")

#size is total funded loan
treemap(mpi.world_region.d3, index="label",vSize="sumfunded_amount.region",vColor="MPI_region",title="Loans by World Region (Total in $M)",title.legend = "Region MPI (mean)", type="value",range=c(0.30,0.05),position.legend= "right", palette=brewer.pal(n=5,"RdYlGn"))
```

As we saw from the $MPI$ distribution, Sub-Saharan Africa is the poorest $World Region$. From the treemap, Sub-Saharan Africa has received a large portion of the total funded loans. While South Asia, high on the poverty index, receives the second smallest portion of funded loans. South Asia might be an area to focus on to identify loan trends. 

```{r, echo=FALSE, fig.height=8,fig.width=17,message=FALSE,warning=FALSE}
# all countries
mpi.loan.country.region.d$label <- paste(mpi.loan.country.region.d$country, mpi.loan.country.region.d$sumfunded_amount, sep=", ")
treemap(mpi.loan.country.region.d, index="label",vSize="sumfunded_amount",vColor="MPI_country",title="Loans by Country (Total in $M)",title.legend = "Country MPI (mean)", type="value",range=c(0.50,0.20),position.legend= "right", palette=brewer.pal(n=5,"RdYlGn"))

# countries within Sub-Saharan Africa
mpi.country.Africa <- filter(mpi.loan.country.region.d, world_region=="Sub-Saharan Africa")
mpi.country.Africa$label <- paste(mpi.country.Africa$country, mpi.country.Africa$sumfunded_amount, sep=", ")
treemap(mpi.country.Africa, index="label",vSize="sumfunded_amount",vColor="MPI_country",title="Loans by Country in Sub-Saharan Africa (Total in $M)",title.legend = "Country MPI (mean)", type="value",range=c(0.50,0.20),position.legend= "right", palette=brewer.pal(n=5,"RdYlGn"))

# countries within Latin America and Caribbean
mpi.country.LA <- filter(mpi.loan.country.region.d, world_region=="Latin America and Caribbean")
mpi.country.LA$label <- paste(mpi.country.LA$country, mpi.country.LA$sumfunded_amount, sep=", ")
treemap(mpi.country.LA, index="label",vSize="sumfunded_amount",vColor="MPI_country",title="Loans by Country in Latin America and Caribbean (Total in $M)",title.legend = "Country MPI (mean)", type="value",range=c(0.50,0.10),position.legend= "right", palette=brewer.pal(n=5,"RdYlGn"))

# countries within South Asia
mpi.country.SA <- filter(mpi.loan.country.region.d, world_region=="South Asia")
mpi.country.SA$label <- paste(mpi.country.SA$country, mpi.country.SA$sumfunded_amount, sep=", ")
treemap(mpi.country.SA, index="label",vSize="sumfunded_amount",vColor="MPI_country",title="Loans by Country in South Asia (Total in $M)",title.legend = "Country MPI (mean)", type="value",range=c(0.50,0.20),position.legend= "right", palette=brewer.pal(n=5,"RdYlGn"))
```

From these treemaps, some of the poorest countries are receiving a small portion of the total Kiva loans. Can see the darker green more prominent in the lower most corner. 

Burkina and South Sudan within Sub-Saharan Africa, Haiti within Latin America and Caribbean, and Afghanistan within South Asia are receiving a small portion of the funded amounts.

Again, these areas of focus for loan trends and what is driving these differences. One thing to consider are potential sector and activity differences between the regions/countries. Do the loan needs of the poorer countries cost less than the others? Can we use this to estimate poverty levels and needs for those countries?

#Frequently Funded Sectors
```{r, echo=FALSE,fig.height=10, fig.width=10,message=FALSE}
par(mfrow=c(2,2))

# countries with funded loans only
kl3 <- kiva_loan1%>%filter(funded_amount==loan_amount)
# create data frame
kl3 <-as.data.frame(table(kiva_loan1$sector,kiva_loan1$year))
colnames(kl3)<-c("sector","year","Frequency")

# bar plots of top 5 funded countries per year
p5 <- kl3%>%filter(year=="2014")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(sector,-Frequency),y=Frequency))+geom_bar(stat="identity",fill=" slateblue")+facet_wrap(~year)+labs(x="",y="")
p6 <- kl3%>%filter(year=="2015")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(sector,-Frequency),y=Frequency))+geom_bar(stat="identity",fill=" slateblue")+facet_wrap(~year)+labs(x="",y="")
p7 <- kl3%>%filter(year=="2016")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(sector,-Frequency),y=Frequency))+geom_bar(stat="identity",fill=" slateblue")+facet_wrap(~year)+labs(x="",y="")
p8 <- kl3%>%filter(year=="2017")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(sector,-Frequency),y=Frequency))+geom_bar(stat="identity",fill=" slateblue")+facet_wrap(~year)+labs(x="",y="")


grid.arrange(p5,p6,p7,p8, nrow=2, bottom="Sector",left="Frequency", top=textGrob("Top 5 Funded Sectors per Year",gp=gpar(fontsize=15,font=10)))

```

From the bar plots, the most frequently funded $sector$s are consistently Agriculture, Food, and Retail. What is the overall loan distribution among the sectors?

```{r, echo=FALSE,fig.height=8, fig.width=15,message=FALSE,warning=FALSE}
# world_regions
#wr <- mpi.loan.join.s.d
#wr <- mpi.loan.join.s.d%>%mutate(allother=ifelse(sector=="Agriculture","Agriculture",ifelse(sector=="Food","Food",ifelse(sector=="Retail","Retail","All Other"))))
# log transform
kiva_loan1$log.funded <- log(kiva_loan1$funded_amount)

ggplot(data = kiva_loan1, aes(x = sector, y = log.funded, fill = sector)) +geom_boxplot() +labs(x = "", y = "Funded Amount",title = "Distribution of Funded Amounts among Sectors")+theme(text=element_text(size=19),axis.text.x=element_text(angle=30, hjust=1))+labs(title = "", subtitle = "", y="",x="")+labs(title = "Distribution of Funded Loans by Sector (Log Scale)", subtitle = "", y="",x="")+theme(plot.title = element_text(hjust=0.5))
  
```

From the box plot, there is some variation in the loan amounts among the $sector$s. The Food, Housing, and Personal Use sectors have the lowest medians. This could correspond to what we saw from the treemaps. So, what is the funded loan breakdown for these top sectors for World Region and Country?

#Proportion of Funded Loans for Sectors by World Region 
```{r, echo=FALSE,fig.height=8, fig.width=10,message=FALSE}
par(mfrow=c(2,2))
sector.subset <- kiva_loan1%>%mutate(allother=ifelse(sector=="Agriculture","Agriculture",ifelse(sector=="Food","Food",ifelse(sector=="Retail","Retail",ifelse(sector=="Housing","Housing",ifelse(sector=="Personal Use","Personal.Use","All Other"))))))

sector.subset <- sector.subset%>%left_join(mpi.c.r,by="country")%>%na.omit()
sector.subset <- sector.subset%>%dplyr::select(partner_id,funded_amount, sector,country,world_region,allother)
sector.subset <- distinct(sector.subset)

#change order
sector.subset$allother <- factor(sector.subset$allother, levels = c("All Other","Retail","Food","Agriculture","Personal.Use","Housing"))
sector.subset <- as.data.frame(sector.subset)
#size is total loan
#top.3.p <- ggplot(top.3, aes(fill=world_region,y=funded_amount.sector,x=sector))+geom_bar(stat="identity",position="fill")+guides(fill=guide_legend(title="World Region"))+theme(text=element_text(size=19))+labs(title = "", subtitle = "", y="",x="")

sector.subset.p <- ggplot(sector.subset, aes(fill=allother,y=funded_amount,x=world_region))+geom_bar(stat="identity",position="fill")+guides(fill=guide_legend(title="Sector"))+theme(text=element_text(size=19),axis.text.x=element_text(angle=30, hjust=1))+labs(title = "", subtitle = "", y="",x="")

grid.arrange(sector.subset.p, nrow=1,left=textGrob("Proportion of Funded Loans",rot=90, gp=gpar(fontsize=14)),bottom=textGrob("World Region", gp=gpar(fontsize=14,font=11)),top=textGrob("Relationship Between World Regions and Top Sectors", gp=gpar(fontsize=14,font=11)))
```

The chart indicates that Agricultural loans make up a good portion of the funded loan amounts. Recalling both the treemap by World Region and the sector boxplots, I would have expected a larger proportion of Personal Use and Housing within Sub-Saharan Africa and South Asia. (I will revisit this). Now we will take a look how $Gender$ plays a role in the dataset. 

##Loan Breakdown by Gender
```{r, echo=FALSE, message=FALSE,warning=FALSE,fig.height=10,fig.width=10}
par(mfrow=c(2, 2))

# gender loan breakdown
sprintf("No. of Total Loans = %s", nrow(kiva_loan1[kiva_loan1$partner_id,]))
sprintf("Female Only Loans = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$F.only.loan==1,])/nrow(kiva_loan1[kiva_loan1$partner_id,])))
sprintf("Male Only Loans = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$M.only.loan==1,])/nrow(kiva_loan1[kiva_loan1$partner_id,])))
sprintf("Female+Male Loans = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$M.F.loan==1,])/nrow(kiva_loan1[kiva_loan1$partner_id,])))

# gender + funded status breakdown
sprintf("Total Loans - Funded = %.0f%%",100* nrow(kiva_loan1[kiva_loan1$fully.funded==1,])/nrow(kiva_loan1[kiva_loan1$partner_id,]))
sprintf("Female Only Loans - Funded = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$F.only.loan==1&kiva_loan1$fully.funded==1,])/nrow(kiva_loan1[kiva_loan1$F.only.loan==1,])))
sprintf("Male Only Loans - Funded = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$M.only.loan==1&kiva_loan1$fully.funded==1,])/nrow(kiva_loan1[kiva_loan1$M.only.loan==1,])))
sprintf("Female+Male Loans - Funded = %.0f%%",100*(nrow(kiva_loan1[kiva_loan1$M.F.loan==1&kiva_loan1$fully.funded==1,])/nrow(kiva_loan1[kiva_loan1$M.F.loan==1,])))

require(IDPmisc)
kiva_loan1 <- NaRV.omit(kiva_loan1) # remove inf values from log scale

# chart proportion visual and then breakout by country and region
detach(package:plyr) #need to detach plyr for grouping to work
gender1<-as.data.frame(table(kiva_loan1$Gender.Var,kiva_loan1$region))
colnames(gender1)<-c("Gender.Var","region","Frequency")
gender.region <- gender1%>%group_by(region)%>%mutate(freq=sum(Frequency),freq.prop=paste(Frequency/sum(Frequency)*100))
gender.region <- gender.region[order(-gender.region$freq),]

gender2<-as.data.frame(table(kiva_loan1$Gender.Var,kiva_loan1$country))
colnames(gender2)<-c("Gender.Var","country","Frequency")
gender.country <- gender2%>%group_by(country)%>%mutate(freq=sum(Frequency),freq.prop=paste(Frequency/sum(Frequency)*100))
gender.country <- gender.country[order(-gender.country$freq),]
# top 10 proportions where male >50%
gender.region$freq.prop <- as.numeric(gender.region$freq.prop)
#tbl_df(gender.region)%>%filter(Gender.Var==2&freq.prop>50) # about 2,300 regions where male prop >50%
#tbl_df(gender.region)%>%filter(Gender.Var==2&freq.prop>50)%>%top_n(10,wt=freq) # top 10 regions based on frequency

gender.country$freq.prop <- as.numeric(gender.country$freq.prop)
#tbl_df(gender.country)%>%filter(Gender.Var==2&freq.prop>50) # 18 countries where male prop >50%
#tbl_df(gender.country)%>%filter(Gender.Var==2&freq.prop>50)%>%top_n(10,wt=freq) # top 10 countries based on frequency

# top freq regions where female > 50%
#tbl_df(gender.region)%>%filter(Gender.Var==1&freq.prop>50) # almost 8,000 regions where female prop >50%
#tbl_df(gender.region)%>%filter(Gender.Var==1&freq.prop>50)%>%top_n(10,wt=freq) # top 10 regions based on frequency

#tbl_df(gender.country)%>%filter(Gender.Var==1&freq.prop>50) # 52 countries where female prop >50%
#tbl_df(gender.country)%>%filter(Gender.Var==1&freq.prop>50)%>%top_n(10,wt=freq) # top 10 countries based on frequency

# plot top 10 proportional regions male and female
gender.f <- gender.region%>%filter(region=="Eldoret"|region=="Kitale"|region=="Lahore"|region=="Managua"|region=="Medellín"|region=="Multan"|region=="Rawalpindi"|region=="San Gabriel"|region=="San Miguel"|region=="Thanh Hoá")
gender.f$Gender.Var1 <- recode(gender.f$Gender.Var,"1"="Female","2"="Male","3"="Male+Female")
gender.m <- gender.region%>%filter(region=="Baniswef"|region=="Ciudad El Triunfo"|region=="El Transito"|region=="Fort Portal"|region=="Gegharkunik region"|region=="Hoima"|region=="Kaduna"|region=="Kamwenge"|region=="Kasese"|region=="Kisii")
gender.m$Gender.Var1 <- recode(gender.f$Gender.Var,"1"="Female","2"="Male","3"="Male+Female")

# plot top 10 proportional countries male and female
gender.fc <- gender.country%>%filter(country=="Philippines"|country=="Kenya"|country=="Cambodia"|country=="Pakistan"|country=="Colombia"|country=="Tajikistan"|country=="El Salvador"|country=="Ecuador"|country=="Vietnam"|country=="Nicaragua")
gender.fc$Gender.Var1 <- recode(gender.fc$Gender.Var,"1"="Female","2"="Male","3"="Male+Female")
gender.mc <- gender.country%>%filter(country=="Uganda"|country=="Palestine"|country=="Nigeria"|country=="Mozambique"|country=="Azerbaijan"|country=="Yemen"|country=="Albania"|country=="Egypt"|country=="Mongolia"|country=="Zambia")
gender.mc$Gender.Var1 <- recode(gender.fc$Gender.Var,"1"="Female","2"="Male","3"="Male+Female")

#ordered by total loan frequency region
topf.plot <- ggplot(gender.f, aes(fill=Gender.Var1, y=Frequency, x=reorder(region,-Frequency)))+geom_bar(stat="identity",position="fill")+scale_fill_manual(values=c("#99CCFF","#006699","#66CC33"))+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=19),axis.text.x=element_text(angle=30, hjust=1))+labs(title = "Highest Number of Female Loans",subtitle = "Sorted by Loan Frequency", y="",x="")+theme(plot.title = element_text(hjust=0.5))
topm.plot<-ggplot(gender.m, aes(fill=Gender.Var1, y=Frequency, x=reorder(region,-Frequency)))+geom_bar(stat="identity",position="fill")+scale_fill_manual(values=c("#99CCFF","#006699","#66CC33"))+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=19),axis.text.x=element_text(angle=30, hjust=1))+labs(title = "Highest Number of Male Loans", subtitle = "Sorted by Loan Frequency", y="",x="")+theme(plot.title = element_text(hjust=0.5))

#ordered by total loan frequency country
topfc.plot <- ggplot(gender.fc, aes(fill=Gender.Var1, y=Frequency, x=reorder(country,-Frequency)))+geom_bar(stat="identity",position="fill")+scale_fill_manual(values=c("#99CCFF","#006699","#66CC33"))+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=19),axis.text.x=element_text(angle=30, hjust=1))+labs(title = "Highest Number of Female Loans",subtitle = "Sorted by Loan Frequency", y="",x="")+theme(plot.title = element_text(hjust=0.5))+theme(plot.subtitle  = element_text(hjust=0.5))
topmc.plot<-ggplot(gender.mc, aes(fill=Gender.Var1, y=Frequency, x=reorder(country,-Frequency)))+geom_bar(stat="identity",position="fill")+scale_fill_manual(values=c("#99CCFF","#006699","#66CC33"))+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=19),axis.text.x=element_text(angle=30, hjust=1))+labs(title = "Highest Number of Male Loans", subtitle = "Sorted by Loan Frequency", y="",x="")+theme(plot.title = element_text(hjust=0.5))+theme(plot.subtitle  = element_text(hjust=0.5))

grid.arrange(topfc.plot,topmc.plot, nrow=2, bottom="Country",left="Frequency", top=textGrob("",gp=gpar(fontsize=15,font=10)))
grid.arrange(topf.plot,topm.plot, nrow=2, bottom="Region",left="Frequency", top=textGrob("",gp=gpar(fontsize=15,font=10)))

# update this to be log.funded to see if it corresponds to the model
```

These charts provide good summaries for the $Gender$ differences across countries and regions. There are clear differences among the countries and regions for who is taking out the loan. 

We will also want to consider if the average loan amount differs between $Gender$ across $Country$. 

```{r echo=FALSE, fig.height=8, fig.width=12,warning=FALSE}

# recode female,male and male,female as the same
kiva_loan1$Gender <- recode(kiva_loan1$Gender, "female,male"="male,female")

# gender differences in funded loan distribution
plot.gender <- ggplot(kiva_loan1, aes(x=Gender, y=log.funded,fill=Gender)) + 
  geom_violin()+labs(title = "", y="",x="")+
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color="red", fill="red") +
    scale_fill_brewer(palette="Set3")+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=16))
# group male,female and male as 0 and female as 1
kiva.gender <-kiva_loan1
kiva.gender$Gender.Var[kiva.gender$Gender.Var==0] <- 0 # female
kiva.gender$Gender.Var[kiva.gender$Gender.Var>0] <- 1 #male and female+male
gender.group <- kiva.gender%>%mutate(Gender1 = recode(Gender.Var, "0"="female", "1"="male,male+female"))

plot.gender2 <- ggplot(gender.group, aes(x=Gender1, y=log.funded,fill=Gender1)) + 
  geom_violin()+labs(title = "", y="",x="")+
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color="red", fill="red") +
    scale_fill_brewer(palette="Set3")+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=16))

grid.arrange(plot.gender,plot.gender2, nrow=1,left=textGrob("Funded Loan (Log Scale)",rot=90, gp=gpar(fontsize=14)),bottom=textGrob("Gender", gp=gpar(fontsize=14,font=11)),top=textGrob("Relationship Between Funded Loan Amount and Gender ", gp=gpar(fontsize=14,font=11)))
```

From the violin plots, there is a difference in the average funded loan amount (red dot) between females and males on an overall basis. 

We may see even bigger differences by looking at the gender differences across World Regions and Countries and over time. 

```{r, echo=FALSE, fig.height=8, fig.width=12,warning=FALSE}
ggplot(kiva_loan1, aes(x=Gender, y=log.funded,fill=Gender)) + 
  geom_violin()+labs(title = "", y="",x="")+
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color="red", fill="red") +
    scale_fill_brewer(palette="Set3")+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=16))+facet_wrap(~year)


```

From the violin plots by year, the average loans overall seem to be decreasing, but also leveling between female, male, and male+female. 

We may see something interesting across World Regions and Countries. 

```{r, echo=FALSE, fig.height=8, fig.width=12,warning=FALSE}
# need to join mpi for world region information with gender
kiva_loan1.red <- kiva_loan1%>%dplyr::select(partner_id, funded_amount, loan_amount, sector, activity, country, use, term_in_months, year, tags, Gender, Gender.Var, Water, log.funded)

kiva_loan1.gr <- world.region%>%left_join(kiva_loan1.red,by="country")%>%na.omit()
kiva_loan1.gr1 <- kiva_loan1.gr%>%filter(kiva_loan1.gr$world_region=="South Asia"|kiva_loan1.gr$world_region=="Sub-Saharan Africa")

# add face_wrap by world_region
ggplot(kiva_loan1.gr1, aes(x=Gender, y=log.funded)) + 
  geom_violin()+labs(title = "", y="",x="")+
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color="red", fill="red") +
    scale_fill_brewer(palette="Set3")+guides(fill=guide_legend(title="Gender"))+theme(text=element_text(size=16))+facet_wrap(~world_region)
```

There was just one loan that had male,female variable for South Asia (in 2014). (We will revisit this in more detail in our modeling)

```{r, echo=FALSE, fig.height=7, fig.width=10,warning=FALSE}
ggplot(funded)+geom_density()+aes(x=log.funded,color=factor(Gender.Var))
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
fit.data <- kiva_loan1
#simple regression
#lm.fit <- lm(log.funded ~ factor(Gender.Var) + sector + country, data = fit.data)
#display(lm.fit)
```

##Logistic Regression
Will take a look at logistic regression for specific $sector$s of interest. For example, Agriculture or not Agriculture outcome on $MPI$. 
```{r,echo=FALSE}
# can look at logistic regression for agriculture or not agriculture outcome on MPI
```

##Multinomial Model with Random Effect
Will take a look at outcome of all $sector$ types and how $MPI$ is asssociated with them. $Sector$ as outcome and $MPI$ as predictor and a random effect. 
```{r,echo=FALSE}
# to look at outcome of all types of sectors and how MPI is associated with the sectors you can have sector as outcome and MPI as predictor and random effect
# multilevel with multinomial model, there are specific packages outside of lme, wrape around stan
```

##Multilevel Model
Here we will look at funded loan amount (log scale) as the outcome, sector as predictor, and gender+country as random effects.
```{r, echo=FALSE,warning=FALSE, message=FALSE}
options(width = 1000)
fit.multi <- lmer(log.funded ~ sector + (1+factor(Gender.Var)|country),data=fit.data)
#summary(fit.multi)
ranef(fit.multi)$country[order(ranef(fit.multi)$country[,2]),] #this orders country from more female dominated to more male dominated countries based on log.funded. The top 10 male dominated countries are: Nepal, Pakistan, Liberia, Myanmar (Burma), Togo, South Sudan, Sierra Leone, Haiti, Samoa, and Lao People's Democratic Republic

# so although we see a high frequency of loans for women in Pakistan the average loan is less
#mean(kiva_loan1[which(kiva_loan1[,27]==2 & kiva_loan1[,6]=="Paraguay"),29])
#mean(kiva_loan1[which(kiva_loan1[,27]==1 & kiva_loan1[,6]=="Paraguay"),29])

# maybe model frequency rather than amount?
```

This orders $Gender$ by country from more female dominated to more male dominated based on funded amount (log scale). The top 10 average loan amounts for male versus female are: Nepal, Pakistan, Liberia, Myanmar (Burma), Togo, South Sudan, Sierra Leone, Haiti, Samoa, and Lao People's Democratic Republic. (Will look into this more)

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# variability among loan amounts across countries for sector/activity and gender
# MPI can have effect on the sector/activity loan
# interaction between gender:country ?
# rather than log have average funded?
# sector intereaciton in gender if we can fit mihgt be interesting. 

#ranef(fit.multi)
#ranef(fit.multi)$country
# top 10 male dominanated        
```

This is a work in progress. There are many different levels to this dataset. 
```{r, echo=FALSE,warning=FALSE,message=FALSE}
#fit1.data <- kiva_loan1
#fit1.data <- NaRV.omit(kiva_loan1)
#fit1 <- lm(log.funded ~ sector, data=fit1.data)
#summary(fit1)
#plot(fit1)

```


##Conclusion/Next Steps
There is a lot to consider in this analysis. This project is ongoing and will be diving deeper into modeling next. It is important to understand the underlying themes and behaviors that differ between regions and countries. This data can help Kiva in supporting these areas. 

##Appendix
Items to look at in the future:

##Where is the use of water loan most prevelant?
```{r, echo=FALSE,message=FALSE,warning=FALSE}
water <- kiva_loan1%>%filter(funded_amount>0)%>%dplyr::select(country,Water)%>%group_by(country)%>%summarise(watertotal=sum(Water),watercount=n())
water1 <- water%>%arrange(desc(watercount))%>%slice(1:5)
plotwater <- ggplot(water1, aes(x=reorder(country,-watercount),y=watercount))+geom_bar(stat="identity",fill="light blue")+scale_fill_manual(values=c("#66CC33"))+theme(plot.title=element_text(hjust =0.5,size=19))+labs(title = "Top 5 Funded Water Loans", y="Frequency",x="Country")
plotwater

```

#How are loans being used?
```{r, echo=FALSE,fig.height=10, fig.width=10,message=FALSE, warning=FALSE}
# countries with funded loans only
kl4 <- kiva_loan1%>%filter(funded_amount>0)
# create data frame
kl4 <-as.data.frame(table(kiva_loan1$use,kiva_loan1$year))
colnames(kl4)<-c("use","year","Frequency")

# bar plots of top 5 funded countries per year
p9 <- kl4%>%filter(year=="2014")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(use,Frequency),y=Frequency,fill=gender))+geom_bar(stat="identity",fill=" skyblue4")+facet_wrap(~year)+labs(x="",y="")+coord_flip()
p10 <- kl4%>%filter(year=="2015")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(use,Frequency),y=Frequency))+geom_bar(stat="identity",fill=" skyblue4")+facet_wrap(~year)+labs(x="",y="")+coord_flip()
p11 <- kl4%>%filter(year=="2016")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(use,Frequency),y=Frequency))+geom_bar(stat="identity",fill=" skyblue4")+facet_wrap(~year)+labs(x="",y="")+coord_flip()
p12 <- kl4%>%filter(year=="2017")%>%top_n(n=5,wt=Frequency)%>%ggplot(aes(x=reorder(use,Frequency),y=Frequency))+geom_bar(stat="identity",fill=" skyblue4")+facet_wrap(~year)+labs(x="",y="")+coord_flip()

grid.arrange(p9,p10,p11,p12, nrow=4, bottom="Frequency",left="Use of Loan", top=textGrob("Top 5 Funded Use of Loans per Year",gp=gpar(fontsize=15,font=10)))
```

From the bar plots, there is some variation in the use of the loan. For water uses, does this vary by region and become more prominent during dry seasons? If there is an expected dry season can we expect water loans to increase?

```{r}

#- Most imporverished areas
#- What is being funded/partially funded/not funded and likelihood?
#- Female vs. male borrowers and whether having a male in the group affects loan behavior?
#- Repeat and type of borrowers
#EDA plot outcome on number of F and number of male and ratio of male count to female count to inform us whether count and proportion make sense. 
#Does a male impact on the loan. 
#Number of females might not matter, but once adding in a male that could affect the loan amount.
#Linear regression model per country on amount of loan for gender
```
